<script>
    // --- 零延時觸控邏輯 (保留) ---
    const targets = document.querySelectorAll('.tap-target');
    targets.forEach(btn => {
        btn.addEventListener('touchstart', function() { this.classList.add('tapped'); }, { passive: true });
        const removeEffect = () => { setTimeout(() => btn.classList.remove('tapped'), 100); };
        btn.addEventListener('touchend', removeEffect);
        btn.addEventListener('touchcancel', removeEffect);
        btn.addEventListener('mousedown', () => btn.classList.add('tapped'));
        btn.addEventListener('mouseup', removeEffect);
    });

    // --- PWA 註冊與訂閱 (優化) ---
    const VAPID_PUB_KEY = "BI8v9P1eO8S_Z3uS7G6X5V4C3B2N1M0L_K9J8H7G6F5D4S3A2P1O0I9U8Y7T6R5E4W";

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').then(reg => {
            console.log('SW Registered');
        });
    }

    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
        return outputArray;
    }

    async function forceSubscribe() {
        if (!('serviceWorker' in navigator)) return;
        try {
            const reg = await navigator.serviceWorker.ready;
            const sub = await reg.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(VAPID_PUB_KEY)
            });
            await fetch('https://jackalchiu.onrender.com/subscribe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(sub)
            });
            console.log("Subscription synced to server");
        } catch (err) { console.error("Subscription failed:", err); }
    }

    document.addEventListener('click', async () => {
        if (Notification.permission === 'default') {
            const permission = await Notification.requestPermission();
            if (permission === 'granted') await forceSubscribe();
        }
    });

    window.onload = () => { 
        if (Notification.permission === 'granted') forceSubscribe(); 
    };
</script>
